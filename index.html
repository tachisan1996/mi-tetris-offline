<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minijuegos Divertidos</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Bootstrap CSS for modals -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <!-- Importa Tone.js para la generaci√≥n de sonido -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    
    <style>
        /* Importa la fuente Inter de Google Fonts */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #a7d9f7 0%, #b2e6b2 100%); /* Degradado pastel */
            display: flex;
            flex-direction: column;
            justify-content: flex-start; /* Alinea al inicio para dejar espacio al t√≠tulo */
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            color: #2d3748;
        }

        h1 {
            color: #007bff; /* Azul vibrante para el t√≠tulo principal */
            margin-bottom: 30px;
            font-size: 2.8em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        /* Contenedor principal del portal o juego */
        .game-container {
            display: flex; /* Flex para el portal y los juegos */
            flex-direction: column;
            align-items: center;
            background-color: #ffffff;
            border-radius: 20px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
            padding: 25px;
            gap: 20px;
            width: 100%; /* Ocupa todo el ancho disponible */
            max-width: 900px; /* Limita el ancho m√°ximo */
            box-sizing: border-box; /* Incluye padding en el ancho */
        }

        .game-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); /* Columnas responsivas */
            gap: 25px;
            padding: 20px;
            width: 100%; /* Ocupa el 100% del contenedor */
        }

        .game-card {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            cursor: pointer;
        }

        .game-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
        }

        .game-icon {
            font-size: 4em; /* Tama√±o grande para los iconos */
            margin-bottom: 10px;
        }

        .game-card h2 {
            font-size: 1.5em;
            margin-bottom: 8px;
            color: #333;
        }

        .game-card p {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 15px;
            flex-grow: 1; /* Permite que la descripci√≥n ocupe espacio */
        }

        .play-button {
            background-color: #28a745; /* Verde para jugar */
            color: white;
            font-weight: bold;
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .play-button:hover {
            background-color: #218838;
        }

        .back-button {
            background-color: #6c757d; /* Gris para volver */
            color: white;
            font-weight: bold;
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s ease;
            margin-top: 20px;
        }

        .back-button:hover {
            background-color: #5a6268;
        }

        /* Contenedor para los juegos individuales (oculto por defecto) */
        .game-screen {
            display: none; /* Oculto por defecto */
            /* Las propiedades de dise√±o (flex, align-items, etc.) se aplican al mostrar */
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 600px; /* Ancho m√°ximo para los juegos individuales */
            background-color: #ffffff;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            padding: 25px;
            box-sizing: border-box;
            gap: 15px;
        }

        /* Estilos espec√≠ficos para el juego Tetris */
        #tetrisCanvas {
            background-color: #e0e7ee;
            border: 4px solid #7cb9e8;
            border-radius: 12px;
            display: block;
            margin: 0 auto;
            touch-action: none;
        }
        #combo-message, #level-up-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 3.2em;
            font-weight: bold;
            color: #ef4444;
            text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.4);
            z-index: 10;
            opacity: 0;
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
            pointer-events: none;
            text-align: center;
        }
        #level-up-message {
            color: #10B981;
            font-size: 2em;
        }
        #combo-message.show, #level-up-message.show {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1.15);
        }
        .game-button.start-button {
            background-color: #10B981;
        }
        .game-button.pause-button {
            background-color: #F59E0B;
        }
        .game-button.start-button:hover {
            background-color: #059669;
        }
        .game-button.pause-button:hover {
            background-color: #D97706;
        }
        .game-button:active {
            transform: scale(0.98);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        @media (max-width: 640px) {
            .game-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 15px;
            }
            .game-card {
                padding: 15px;
            }
            .game-icon {
                font-size: 3em;
            }
            .game-card h2 {
                font-size: 1.2em;
            }
            .game-card p {
                font-size: 0.8em;
            }
            #combo-message {
                font-size: 2.5em;
            }
            #level-up-message {
                font-size: 1.5em;
            }
            .game-button {
                padding: 0.6rem 1.2rem;
                font-size: 1em;
            }
        }

        /* Custom styles for the crossword grid based on table structure */
        /* CSS Variables for custom colors - Updated to pastel vivo palette */
        :root {
            --c: #B19CD9; /* Soft Lavender for vertical word */
            --d: #AEC6CF; /* Muted Blue for cell border */
            --e: #E0FFFF; /* Light Cyan for empty cell background */
            --f: #A7D9B4; /* Soft Green for correct word / hover background */
            --h: #333333; /* Dark Grey for text in filled cells */
            --table-primary: var(--c); 
            --table-secondary: var(--e);
            --table-border: var(--d);
            --correct-answer: var(--f);
            --wrong-answer: #EF4444; /* Red for error, kept for clear indication */
        }

        .crossword-table {
            border-collapse: collapse;
            margin: 0 auto;
        }

        .crossword-table td {
            width: 40px; /* Reduced width for more compact grid */
            height: 40px; /* Reduced height for more compact grid */
            border: 1px solid var(--table-border);
            text-align: center;
            vertical-align: middle;
            background-color: var(--e); /* Empty cell background */
            position: relative; /* For input positioning */
            border-radius: 4px; /* Rounded corners for cells */
        }

        .crossword-table td input {
            width: 100%;
            height: 100%;
            border: none;
            background-color: transparent;
            text-align: center;
            font-weight: bold;
            text-transform: uppercase;
            color: var(--h); /* Text color */
            padding: 0;
            outline: none;
            box-shadow: none;
            border-radius: 4px; /* Match cell rounding */
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
            font-size: 1.2rem; /* Reduced font size for better fit */
        }

        .crossword-table .table-primary {
            background-color: var(--table-primary); /* Vertical word cell color */
        }

        .crossword-table .table-secondary {
            background-color: var(--table-secondary); /* Fillable cell background */
        }

        .crossword-table .table-secondary input.correct-answer {
            background-color: var(--correct-answer); /* Correct answer background */
            color: var(--h); /* Text color for correct answer, adjusted to contrast with pastel */
        }

        .crossword-table .table-secondary input.wrong-answer {
            background-color: var(--wrong-answer); /* Wrong answer background */
            color: white;
        }

        .crossword-cell.flash-correct {
            animation: flashCorrect 0.5s ease-out;
        }

        @keyframes flashCorrect {
            0% { background-color: #d1fae5; /* green-100 */ }
            50% { background-color: #34d399; /* green-400 */ }
            100% { background-color: var(--correct-answer); } /* Revert to correct-answer color */
        }

        /* Style for guessed hints */
        .hint-guessed {
            text-decoration: line-through;
            color: #9ca3af; /* gray-400 */
        }

        .progress-bar {
            transition: width 0.5s ease-in-out;
        }

        /* Estilos para el nuevo juego "Juego Simple con Niveles" */
        /* Redefinici√≥n de game-container para este juego espec√≠fico */
        #simple-game-section.game-screen {
            background-color: #2d3748; /* Contenedor m√°s claro */
            padding: 2rem;
            border-radius: 1rem; /* Esquinas m√°s redondeadas */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5), 0 4px 6px -2px rgba(0, 0, 0, 0.2); /* Sombra m√°s profunda */
            max-width: 800px; /* Ancho m√°ximo para pantallas grandes */
            position: relative;
            justify-content: center; /* Centrar contenido */
        }

        .simple-game-stats {
            display: flex;
            justify-content: space-between;
            width: 100%;
            padding: 0.5rem 1rem;
            color: #e2e8f0; /* Texto claro */
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 1rem;
        }

        #simpleGameCanvas {
            background-color: #4a5568; /* Color del lienzo */
            display: block;
            border-radius: 0.75rem; /* Esquinas redondeadas para el lienzo */
            box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.3); /* Sombra interna para el lienzo */
            width: 100%; /* Ajuste de ancho */
            height: auto; /* Ajuste de altura */
            aspect-ratio: 16 / 9; /* Mantener la proporci√≥n de aspecto */
        }

        .simple-game-control-panel {
            margin-top: 1.5rem;
            display: flex;
            gap: 1rem; /* Espacio entre botones */
            flex-wrap: wrap; /* Permite que los botones se envuelvan en pantallas peque√±as */
            justify-content: center;
        }

        .simple-game-control-panel button {
            background-color: #48bb78; /* Verde esmeralda */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            border: none;
            cursor: pointer;
            font-size: 1.125rem;
            font-weight: bold;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            position: relative;
            overflow: hidden;
            background-image: linear-gradient(to right, #48bb78 0%, #38a169 100%);
        }

        .simple-game-control-panel button:hover {
            background-color: #38a169; /* Verde m√°s oscuro al pasar el rat√≥n */
            transform: translateY(-2px);
            box-shadow: 0 6px 8px -1px rgba(0, 0, 0, 0.15), 0 4px 6px -2px rgba(0, 0, 0, 0.1);
        }

        .simple-game-control-panel button:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.06);
        }

        .simple-game-control-panel button::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 300%;
            height: 300%;
            background-color: rgba(255, 255, 255, 0.15);
            border-radius: 50%;
            transition: all 0.75s ease-out;
            transform: translate(-50%, -50%) scale(0);
            z-index: 0;
        }

        .simple-game-control-panel button:hover::before {
            transform: translate(-50%, -50%) scale(1);
        }

        .simple-game-message-box {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.9); /* Fondo m√°s oscuro para mensajes */
            color: white;
            padding: 2rem 3rem;
            border-radius: 1rem;
            text-align: center;
            font-size: 1.6rem;
            font-weight: bold;
            z-index: 100;
            display: none; /* Oculto por defecto */
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.9);
            border: 3px solid #63b3ed; /* Borde azul claro para mensajes */
        }

        .simple-game-message-box button {
            margin-top: 1.5rem;
            padding: 0.8rem 2rem;
            font-size: 1.3rem;
            background-image: linear-gradient(to right, #4299e1 0%, #3182ce 100%); /* Azul para el bot√≥n de aceptar */
        }

        @media (max-width: 640px) {
            #simple-game-section.game-screen {
                padding: 1rem;
            }
            .simple-game-control-panel button {
                padding: 0.6rem 1.2rem;
                font-size: 1rem;
            }
            .simple-game-stats {
                font-size: 0.9rem;
            }
            .simple-game-message-box {
                font-size: 1.2rem;
                padding: 1.5rem 2rem;
            }
            .simple-game-message-box button {
                font-size: 1rem;
                padding: 0.6rem 1.2rem;
            }
        }
    </style>
</head>
<body>
    <!-- Secci√≥n Principal del Portal de Juegos -->
    <div id="game-portal-section" class="game-container">
        <h1>Minijuegos Divertidos</h1>
        <div class="game-grid">
            <!-- Tarjeta del Juego Tetris -->
            <div class="game-card" data-game-id="tetris">
                <span class="game-icon">üß±</span>
                <h2>Tetris Pastel Intenso</h2>
                <p>¬°El cl√°sico juego de bloques con colores vibrantes y chistes!</p>
                <button class="play-button">Jugar</button>
            </div>

            <!-- Tarjeta del Juego de Crucigrama -->
            <div class="game-card" data-game-id="crossword">
                <span class="game-icon">üìù</span> <!-- Icono de l√°piz/papel -->
                <h2>Crucigrama Cultural</h2>
                <p>¬°Pon a prueba tus conocimientos con este divertido crucigrama!</p>
                <button class="play-button">Jugar</button>
            </div>

            <!-- Tarjeta del Juego Simple con Niveles -->
            <div class="game-card" data-game-id="simple-game">
                <span class="game-icon">üèÉ</span> <!-- Icono de corredor/persona en movimiento -->
                <h2>Juego Simple con Niveles</h2>
                <p>¬°Esquiva obst√°culos y recolecta puntos en este juego de niveles!</p>
                <button class="play-button">Jugar</button>
            </div>
        </div>
    </div>

    <!-- Secci√≥n del Juego Tetris (Oculta por defecto) -->
    <div id="tetris-game-section" class="game-screen">
        <h1 class="text-4xl md:text-5xl font-extrabold text-blue-600 mb-4 text-center">Tetris Pastel Intenso</h1>
        <div id="game-info">
            Puntuaci√≥n: <span id="score">0</span> | Nivel: <span id="level">1</span> | Siguiente: <span id="next-piece-display"></span>
        </div>
        <canvas id="tetrisCanvas"></canvas>
        <div id="game-message"></div>
        <div id="combo-message"></div>
        <div id="level-up-message"></div>

        <div class="button-container">
            <button id="tetris-start-button" class="game-button start-button">Iniciar Juego</button>
            <button id="tetris-pause-button" class="game-button pause-button hidden">Pausar</button>
            <button id="tetris-mute-button" class="game-button pause-button">Silenciar M√∫sica</button> <!-- Bot√≥n de silenciar/reactivar -->
        </div>
        <button id="back-to-portal-tetris" class="back-button">Volver a Minijuegos</button>
    </div>

    <!-- Secci√≥n del Juego de Crucigrama (Oculta por defecto) -->
    <div id="crossword-game-section" class="game-screen">
        <h1 class="text-4xl font-extrabold text-center text-gray-800 mb-6">
            <span class="bg-clip-text text-transparent bg-gradient-to-r from-blue-500 to-purple-600">Crucigramas</span>
            <span class="block text-2xl text-gray-600 mt-2">Cultura General</span>
        </h1>

        <!-- Level Selection -->
        <div id="level-selection" class="flex flex-col items-center justify-center space-y-4">
            <p class="text-lg text-gray-700">Selecciona un nivel para comenzar:</p>
            <div class="flex flex-wrap justify-center gap-4">
                <button id="btn-facil" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">F√°cil</button>
                <button id="btn-medio" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">Medio</button>
                <button id="btn-dificil" class="bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">Dif√≠cil</button>
            </div>
        </div>

        <!-- Game Area -->
        <div id="game-area" class="hidden flex flex-col md:flex-row gap-8">
            <!-- Left Panel: Crossword Grid -->
            <div class="flex-1 bg-gray-50 p-6 rounded-lg shadow-inner">
                <h2 id="crossword-title" class="text-2xl font-semibold text-gray-700 mb-4 text-center"></h2>
                <div id="cpuzzle" class="crossword-grid mx-auto">
                    <!-- Crossword table will be injected here by JavaScript -->
                </div>
                <div class="mt-4">
                    <div class="progress" role="progressbar" aria-label="Progreso del Crucigrama" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                        <div class="progress-bar progress-bar-striped progress-bar-animated bg-blue-500" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- Right Panel: Pistas and Input -->
            <div class="flex-1 bg-gray-50 p-6 rounded-lg shadow-inner flex flex-col space-y-6">
                <div>
                    <h3 class="text-xl font-semibold text-gray-700 mb-3">Pistas:</h3>
                    <ol id="references" class="list-decimal list-inside text-gray-600 space-y-1 text-sm md:text-base">
                        <!-- Hints will be injected here by JavaScript -->
                    </ol>
                </div>

                <div class="flex flex-col space-y-4">
                    <h3 class="text-xl font-semibold text-gray-700 mb-2">Ingresar Respuesta (Clic en celda para escribir):</h3>
                    <div id="message-display" class="text-center font-medium mt-2 transition duration-300 ease-in-out"></div>
                </div>
                <div id="score-display" class="text-xl font-semibold text-gray-700 text-center mt-4">Puntuaci√≥n: 0</div>
                <div id="crossword-counter" class="text-lg text-gray-500 text-center">Crucigrama 0 de 5</div>

                <button id="reveal-letter-btn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition duration-300 ease-in-out transform hover:scale-105 mt-4">Revelar Letra (10 Puntos)</button>
                <button id="next-crossword-btn" class="hidden bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition duration-300 ease-in-out transform hover:scale-105 mt-4">Siguiente Crucigrama</button>
                <button id="restart-game-btn" class="hidden bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition duration-300 ease-in-out transform hover:scale-105 mt-2">Reiniciar Crucigrama Actual</button>
                <button id="menu-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition duration-300 ease-in-out transform hover:scale-105 mt-2">Men√∫ Principal</button>
                <button id="config-btn" class="bg-yellow-400 hover:bg-yellow-500 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition duration-300 ease-in-out transform hover:scale-105 mt-2" data-bs-toggle="modal" data-bs-target="#configurationModal">
                    ‚öôÔ∏è Configurar Colores
                </button>
            </div>
        </div>

        <!-- Bootstrap Modal for Configuration -->
        <div class="modal fade" id="configurationModal" tabindex="-1" data-bs-backdrop="static" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header">
                        <h1 class="modal-title fs-5" id="exampleModalLabel">üî© Configuraci√≥n</h1>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form class="form" id="colorForm">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="colorC" class="form-label">Palabra vertical:</label>
                                    <input type="color" class="form-control form-control-color w-100" id="colorC" name="colorC" value="#B19CD9">
                                </div>
                                <div class="col-md-6">
                                    <label for="colorD" class="form-label">Borde de las celdas:</label>
                                    <input type="color" class="form-control form-control-color w-100" id="colorD" name="colorD" value="#AEC6CF">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="colorE" class="form-label">Celdas vac√≠as:</label>
                                    <input type="color" class="form-control form-control-color w-100" id="colorE" name="colorE" value="#E0FFFF">
                                </div>
                                <div class="col-md-6">
                                    <label for="colorF" class="form-label">Palabra correcta/hover:</label>
                                    <input type="color" class="form-control form-control-color w-100" id="colorF" name="colorF" value="#A7D9B4">
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer d-flex justify-content-evenly align-items-center">
                        <button type="button" class="btn btn-primary d-flex align-items-center" onclick="reiniciarColores()">
                            üîÑ Reiniciar valores
                        </button>
                        <button type="button" class="btn btn-primary d-flex align-items-center" onclick="saveColors()">
                            üíΩ Guardar cambios
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Custom success modal -->
        <div class="modal fade" id="successModal" tabindex="-1" role="dialog" aria-labelledby="successModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered" role="document">
                <div class="modal-content">
                    <div class="modal-header bg-green-500 text-white">
                        <h5 class="modal-title" id="successModalLabel">¬°Felicidades!</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body text-center text-lg text-gray-700">
                        ¬°Has completado el crucigrama con √©xito!
                    </div>
                    <div class="modal-footer justify-content-center">
                        <button type="button" class="btn btn-success" data-bs-dismiss="modal">Cerrar</button>
                    </div>
                </div>
            </div>
        </div>
        <button id="back-to-portal-crossword" class="back-button">Volver a Minijuegos</button>
    </div>

    <!-- Secci√≥n del Juego Simple con Niveles (Oculta por defecto) -->
    <div id="simple-game-section" class="game-screen">
        <h1 class="text-4xl md:text-5xl font-extrabold text-blue-600 mb-4 text-center">Juego Simple con Niveles</h1>
        <div class="simple-game-stats">
            <span>Nivel: <span id="simpleGameLevelDisplay">1</span></span>
            <span>Puntuaci√≥n: <span id="simpleGameScoreDisplay">0</span></span>
            <span>Objetivos Nivel: <span id="simpleGameLevelScoreDisplay">0</span>/50</span>
        </div>
        <canvas id="simpleGameCanvas"></canvas>
        <div class="simple-game-control-panel">
            <button id="simpleGameStartButton">Iniciar Juego</button>
            <button id="simpleGamePauseButton" style="background-image: linear-gradient(to right, #ecc94b 0%, #d69e2e 100%);">Pausa</button>
            <button id="simpleGameStopButton" style="background-image: linear-gradient(to right, #ef4444 0%, #dc2626 100%);">Detener Juego</button>
        </div>
        <div id="simpleGameMessageBox" class="simple-game-message-box">
            <p id="simpleGameMessageText"></p>
            <button class="mt-4" style="background-image: linear-gradient(to right, #3b82f6 0%, #2563eb 100%);" id="simpleGameMessageBoxButton">Aceptar</button>
        </div>
        <button id="back-to-portal-simple-game" class="back-button">Volver a Minijuegos</button>
    </div>

    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

    <script>
        // --- Global Navigation Variables ---
        const gamePortalSection = document.getElementById('game-portal-section');
        const tetrisGameSection = document.getElementById('tetris-game-section');
        const crosswordGameSection = document.getElementById('crossword-game-section');
        const simpleGameSection = document.getElementById('simple-game-section'); // New game

        const allGameSections = [tetrisGameSection, crosswordGameSection, simpleGameSection];

        // --- Navigation Functions ---
        function showSection(sectionToShow) {
            allGameSections.forEach(section => {
                section.style.display = 'none'; // Hide all game sections
            });
            gamePortalSection.style.display = 'none'; // Hide the portal section

            // Display the selected section as flex for proper layout
            sectionToShow.style.display = 'flex';
        }

        function showGamePortal() {
            allGameSections.forEach(section => {
                section.style.display = 'none'; // Hide all game sections
            });
            gamePortalSection.style.display = 'flex'; // Show the portal section
        }

        // --- Event Listeners for Game Cards (Portal) ---
        document.querySelectorAll('.game-card .play-button').forEach(button => {
            button.addEventListener('click', (event) => {
                // Start the audio context only when the user interacts for the first time
                Tone.start();

                const gameId = event.target.closest('.game-card').dataset.gameId;
                if (gameId === 'tetris') {
                    showSection(tetrisGameSection);
                    // If Tetris is already initialized and the game is over or not started, restart it.
                    if (window.tetrisGame && (window.tetrisGame.gameOver() || !window.tetrisGame.gameStarted())) {
                        window.tetrisGame.startGame();
                    } else if (window.tetrisGame && window.tetrisGame.isPaused()) {
                         // If paused, just show the paused game screen.
                    } else if (!window.tetrisGame) {
                        // If Tetris is loaded for the first time
                        document.getElementById('game-message').textContent = 'Pulsa "Iniciar Juego" para jugar';
                        document.getElementById('game-message').classList.remove('hidden');
                        document.getElementById('tetris-start-button').classList.remove('hidden');
                        document.getElementById('tetris-pause-button').classList.add('hidden');
                    }
                } else if (gameId === 'crossword') {
                    showSection(crosswordGameSection);
                    // Call the new crossword start function to show level selection
                    setupLevelButtons(); // Show crossword level selection buttons
                    gameAreaDiv.classList.add('hidden'); // Hide game area until a level is chosen
                    levelSelectionDiv.classList.remove('hidden'); // Show level selection
                } else if (gameId === 'simple-game') { // New game
                    showSection(simpleGameSection);
                    window.simpleGame.init(); // Initialize the simple game
                }
            });
        });

        // --- Back to Portal Buttons ---
        document.getElementById('back-to-portal-tetris').addEventListener('click', () => {
            if (window.tetrisGame && !window.tetrisGame.gameOver()) {
                // Pause Tetris if returning to portal and game is active
                if (!window.tetrisGame.isPaused()) {
                    window.tetrisGame.togglePause();
                }
            }
            window.tetrisGame.stopBackgroundMusic(); // Stop music when leaving Tetris
            showGamePortal();
        });
        document.getElementById('back-to-portal-crossword').addEventListener('click', () => {
            levelSelectionDiv.classList.remove('hidden'); // Show level selection buttons
            gameAreaDiv.classList.add('hidden'); // Hide game area
            showGamePortal();
        });
        document.getElementById('back-to-portal-simple-game').addEventListener('click', () => {
            window.simpleGame.stopGame(); // Stop the simple game before returning
            showGamePortal();
        });


        // --- TETRIS GAME LOGIC (Encapsulated) ---
        window.tetrisGame = (() => {
            const canvas = document.getElementById('tetrisCanvas');
            const ctx = canvas.getContext('2d');

            const COLS = 10; // Board columns
            const ROWS = 20; // Board rows
            const BLOCK_SIZE = 28; // Size of each block in pixels

            canvas.width = COLS * BLOCK_SIZE;
            canvas.height = ROWS * BLOCK_SIZE;

            // Pastel color palettes for different levels
            const COLOR_PALETTES = [
                [ '#FF69B4', '#FFD700', '#00BFFF', '#32CD32', '#FF4500', '#4169E1', '#9932CC' ], // Bright pastel
                [ '#FF00FF', '#FFFF00', '#00FFFF', '#00FF00', '#FF0000', '#0000FF', '#8A2BE2' ], // Primary colors
                [ '#9ACD32', '#DAA520', '#6B8E23', '#5F9EA0', '#D2691E', '#8B4513', '#A0522D' ], // Earth tones
                [ '#4B0082', '#1E90FF', '#BA55D3', '#20B2AA', '#FF1493', '#7B68EE', '#4682B4' ], // Cool tones
                [ '#F08080', '#ADD8E6', '#90EE90', '#FFB6C1', '#DDA0DD', '#87CEEB', '#FFDAB9' ]  // Warm and soft tones
            ];
            let COLORS = COLOR_PALETTES[0]; // Current color palette, starts with the first one

            let board = []; // Game board
            let currentPiece; // The piece currently falling
            let nextPiece; // The next piece to fall
            let score = 0; // Current score
            let gameOver = false; // Game state (true if game over)
            let gameLoopId; // ID of the game loop for requestAnimationFrame
            let lastUpdateTime = 0; // Timestamp of the last update to control falling

            let level = 1; // Current level
            let linesClearedTotal = 0; // Total lines cleared
            const BASE_FALL_INTERVAL = 600; // Base fall interval (ms)
            let currentFallInterval = BASE_FALL_INTERVAL; // Current fall interval
            let nextLevelScoreThreshold = 500; // Score for the next level
            let isPaused = false; // Pause state
            let gameStarted = false; // Indicates if the game has started
            let isMuted = false; // Mute state for background music

            // DOM elements to update the UI
            const scoreDisplay = document.getElementById('score');
            const levelDisplay = document.getElementById('level');
            const gameMessage = document.getElementById('game-message');
            const nextPieceDisplay = document.getElementById('next-piece-display');
            const comboMessageElement = document.getElementById('combo-message');
            const levelUpMessageElement = document.getElementById('level-up-message');
            const startButton = document.getElementById('tetris-start-button');
            const pauseButton = document.getElementById('tetris-pause-button');
            const muteButton = document.getElementById('tetris-mute-button'); // New mute button

            // --- Tone.js Synths for Tetris ---
            const lockSynth = new Tone.MembraneSynth().toDestination(); // For piece locking
            const lineClearSynth = new Tone.PolySynth(Tone.Synth, {
                oscillator: { type: "triangle" },
                envelope: { attack: 0.01, decay: 0.1, sustain: 0.05, release: 0.1 }
            }).toDestination(); // For line clears
            const rotateSynth = new Tone.Synth({
                oscillator: { type: "sine" },
                envelope: { attack: 0.001, decay: 0.05, sustain: 0.01, release: 0.05 }
            }).toDestination(); // For rotation
            const gameOverSynth = new Tone.NoiseSynth({
                noise: { type: 'pink' },
                envelope: { attack: 0.01, decay: 0.5, sustain: 0, release: 1 }
            }).toDestination(); // For game over

            // Background music synth and sequence for Tetris (Sailor Moon Opening)
            const backgroundMusicSynth = new Tone.PolySynth(Tone.Synth, {
                oscillator: { type: "sawtooth" },
                envelope: { attack: 0.02, decay: 0.3, sustain: 0.1, release: 0.5 },
                volume: -10 // Adjust volume to not overpower sound effects
            }).toDestination();

            // Sailor Moon Opening (simplified instrumental melody)
            const sailorMoonMelody = new Tone.Sequence((time, note) => {
                backgroundMusicSynth.triggerAttackRelease(note, "8n", time);
            }, [
                "E4", "F#4", "G#4", "A4", "B4", "C#5", "B4", "A4", "G#4", "F#4",
                "E4", "F#4", "G#4", "A4", "B4", "C#5", "D5", "E5", "D5", "C#5",
                "B4", "A4", "G#4", "F#4", "E4", "F#4", "G#4", "A4", "B4", "C#5",
                "B4", "A4", "G#4", "F#4", "E4", "F#4", "G#4", "A4", "B4", "C#5",
                "D5", "E5", "D5", "C#5", "B4", "A4", "G#4", "F#4"
            ], "8n"); // Each note lasts an 8th note

            sailorMoonMelody.loop = true; // Loop the melody
            sailorMoonMelody.bpm = 120; // Set BPM for the melody

            // Tetromino shapes and their initial colors
            const TETROMINO_SHAPES = {
                'I': { shape: [[1, 1, 1, 1]], colorIndex: 0 },
                'O': { shape: [[1, 1], [1, 1]], colorIndex: 1 },
                'T': { shape: [[0, 1, 0], [1, 1, 1]], colorIndex: 2 },
                'S': { shape: [[0, 1, 1], [1, 1, 0]], colorIndex: 3 },
                'Z': { shape: [[1, 1, 0], [0, 1, 1]], colorIndex: 4 },
                'J': { shape: [[1, 0, 0], [1, 1, 1]], colorIndex: 5 },
                'L': { shape: [[0, 0, 1], [1, 1, 1]], colorIndex: 6 }
            };

            // Class to represent a Tetris piece
            class Piece {
                constructor(shapeType) {
                    const { shape, colorIndex } = TETROMINO_SHAPES[shapeType];
                    this.shape = shape;
                    this.color = COLORS[colorIndex];
                    // Position the piece in the top center of the board
                    this.x = Math.floor(COLS / 2) - Math.floor(shape[0].length / 2);
                    this.y = 0;
                    this.shapeType = shapeType;
                }

                // Draws the piece on the canvas
                draw() {
                    this.shape.forEach((row, r) => {
                        row.forEach((value, c) => {
                            if (value > 0) { // If the shape cell is not empty
                                ctx.fillStyle = this.color;
                                ctx.fillRect(this.x * BLOCK_SIZE + c * BLOCK_SIZE, this.y * BLOCK_SIZE + r * BLOCK_SIZE, BLOCK_SIZE, BLOCK_SIZE);
                                ctx.strokeStyle = '#fff'; // White border
                                ctx.lineWidth = 1;
                                ctx.strokeRect(this.x * BLOCK_SIZE + c * BLOCK_SIZE, this.y * BLOCK_SIZE + r * BLOCK_SIZE, BLOCK_SIZE, BLOCK_SIZE);
                            }
                        });
                    });
                }

                // Moves the piece on the board (dx, dy are changes in x and y)
                move(dx, dy) {
                    if (!this.collision(dx, dy, this.shape)) {
                        this.x += dx;
                        this.y += dy;
                        return true; // Successful move
                    }
                    return false; // Collision detected
                }

                // Rotates the piece
                rotate() {
                    // Function to transpose a matrix (swap rows and columns)
                    const transpose = (matrix) => matrix[0].map((_, i) => matrix.map(row => row[i]));
                    // Function to reverse the rows of a matrix
                    const reverseRows = (matrix) => matrix.map(row => [...row].reverse());

                    let rotatedShape = transpose(this.shape);
                    // Specific rotation rules for some pieces
                    if (this.shapeType === 'I' || this.shapeType === 'S' || this.shapeType === 'Z') {
                        rotatedShape = reverseRows(rotatedShape);
                    } else {
                        rotatedShape = rotatedShape.reverse();
                    }

                    // Try to rotate if there is no collision
                    if (!this.collision(0, 0, rotatedShape)) {
                        this.shape = rotatedShape;
                        rotateSynth.triggerAttackRelease("C4", "16n"); // Play rotation sound
                        return true;
                    }
                    // Implement "Wall Kick" (offset to avoid collisions when rotating)
                    const kicks = [[0, 0], [-1, 0], [1, 0], [0, -1], [-1, -1], [1, -1]];
                    for (let i = 0; i < kicks.length; i++) {
                        const [dx, dy] = kicks[i];
                        if (!this.collision(dx, dy, rotatedShape)) {
                            this.x += dx;
                            this.y += dy;
                            this.shape = rotatedShape;
                            rotateSynth.triggerAttackRelease("C4", "16n"); // Play rotation sound
                            return true;
                        }
                    }
                    return false; // Could not rotate
                }

                // Checks if the piece collides with board boundaries or other pieces
                collision(dx, dy, newShape) {
                    for (let r = 0; r < newShape.length; r++) {
                        for (let c = 0; c < newShape[r].length; c++) {
                            if (newShape[r][c] > 0) {
                                let newX = this.x + c + dx;
                                let newY = this.y + r + dy;

                                // Check collisions with board boundaries or existing pieces
                                if (newX < 0 || newX >= COLS || newY >= ROWS || (newY >= 0 && board[newY][newX] !== 'empty')) {
                                    return true;
                                }
                            }
                        } // Fixed: Missing closing brace for inner loop
                    }
                    return false; // No collision
                }

                // Locks the piece to the board when it hits something
                lock() {
                    this.shape.forEach((row, r) => {
                        row.forEach((value, c) => {
                            if (value > 0) {
                                let boardX = this.x + c;
                                let boardY = this.y + r;
                                // If the piece locks above the board, it's Game Over
                                if (boardY < 0) {
                                    gameOver = true;
                                    gameMessage.textContent = '¬°Game Over!';
                                    gameMessage.classList.remove('hidden');
                                    startButton.textContent = "Reiniciar Juego"; // Change button text
                                    startButton.classList.remove('hidden');
                                    pauseButton.classList.add('hidden');
                                    cancelAnimationFrame(gameLoopId); // Stop game loop
                                    gameOverSynth.triggerAttackRelease("4n"); // Play game over sound
                                    sailorMoonMelody.stop(); // Stop background music
                                    return;
                                }
                                board[boardY][boardX] = this.color; // Assign piece color to board cell
                            }
                        });
                    });
                    lockSynth.triggerAttackRelease("C3", "16n"); // Play lock sound
                    this.clearLines(); // Try to clear lines
                    this.generateNewPiece(); // Generate a new piece
                }

                // Clears complete lines from the board
                clearLines() {
                    let linesCleared = 0;
                    for (let r = ROWS - 1; r >= 0; r--) {
                        // If the line is complete
                        if (board[r].every(cell => cell !== 'empty')) {
                            linesCleared++;
                            board.splice(r, 1); // Remove the line
                            board.unshift(Array(COLS).fill('empty')); // Add a new empty line at the top
                            r++; // Recheck the same row, as those above have moved down
                        }
                    }
                    if (linesCleared > 0) {
                        score += linesCleared * 100 * level; // Increase score
                        scoreDisplay.textContent = score;
                        linesClearedTotal += linesCleared;

                        // Play line clear sound
                        const notes = ["C4", "E4", "G4"];
                        if (linesCleared === 2) notes.push("C5");
                        if (linesCleared === 3) notes.push("E5");
                        if (linesCleared === 4) notes.push("G5", "C6");
                        lineClearSynth.triggerAttackRelease(notes, "8n");

                        // Logic to level up
                        if (level < 10 && score >= nextLevelScoreThreshold) {
                            level++;
                            levelDisplay.textContent = level;
                            nextLevelScoreThreshold += 1000; // Increase threshold for next level
                            currentFallInterval = Math.max(50, BASE_FALL_INTERVAL - (level * 75)); // Accelerate fall
                            isPaused = true; // Temporarily pause the game to show level message
                            pauseButton.textContent = "Reanudar";
                            cancelAnimationFrame(gameLoopId); // Stop current animation
                            initBoard(); // Reset the board (to clear any "ghost" pieces)
                            drawBoard(); // Redraw the board
                            COLORS = COLOR_PALETTES[(level -1) % COLOR_PALETTES.length]; // Change color palette
                            displayLevelUpMessage(); // Show a level up message
                        }

                        // Show combo messages
                        if (linesCleared === 2) { displayComboMessage('¬°Doble!'); }
                        else if (linesCleared === 3) { displayComboMessage('¬°Triple!'); }
                        else if (linesCleared === 4) { displayComboMessage('¬°Tetris!'); }
                    }
                }

                // Generates the next piece and the current piece
                generateNewPiece() {
                    currentPiece = nextPiece; // The next piece becomes the current one
                    nextPiece = this.randomPiece(); // Generate a new next piece
                    this.drawNextPiece(); // Draw the next piece in its display area

                    // Check if the new piece collides on appearance (immediate Game Over)
                    if (currentPiece.collision(0, 0, currentPiece.shape)) {
                        gameOver = true;
                        gameMessage.textContent = '¬°Game Over!';
                        gameMessage.classList.remove('hidden');
                        startButton.textContent = "Reiniciar Juego";
                        startButton.classList.remove('hidden');
                        pauseButton.classList.add('hidden');
                        cancelAnimationFrame(gameLoopId); // Stop game loop
                        gameOverSynth.triggerAttackRelease("4n"); // Play game over sound
                        sailorMoonMelody.stop(); // Stop background music
                    }
                }

                // Creates a random Tetris piece
                randomPiece() {
                    const types = Object.keys(TETROMINO_SHAPES);
                    const randType = types[Math.floor(Math.random() * types.length)];
                    return new Piece(randType);
                }

                // Draws the next piece in its container
                drawNextPiece() {
                    nextPieceDisplay.innerHTML = ''; // Clear the container
                    const tempCanvas = document.createElement('canvas'); // Create a temporary canvas
                    const tempCtx = tempCanvas.getContext('2d');
                    tempCanvas.width = 4 * BLOCK_SIZE; // Size for preview
                    tempCanvas.height = 4 * BLOCK_SIZE;
                    tempCanvas.style.display = 'inline-block';
                    tempCanvas.style.verticalAlign = 'middle';
                    tempCanvas.style.marginLeft = '10px';
                    tempCanvas.style.backgroundColor = '#e0f4f8';
                    tempCanvas.style.borderRadius = '8px';
                    tempCanvas.style.border = '2px solid #a7d9f7';

                    nextPiece.shape.forEach((row, r) => {
                        row.forEach((value, c) => {
                            if (value > 0) {
                                tempCtx.fillStyle = nextPiece.color;
                                tempCtx.fillRect(c * BLOCK_SIZE, r * BLOCK_SIZE, BLOCK_SIZE, BLOCK_SIZE);
                                tempCtx.strokeStyle = '#fff';
                                tempCtx.lineWidth = 1;
                                tempCtx.strokeRect(c * BLOCK_SIZE, r * BLOCK_SIZE, BLOCK_SIZE, BLOCK_SIZE);
                            }
                        });
                    });
                    nextPieceDisplay.appendChild(tempCanvas);
                }
            }

            // Initializes the board with empty cells
            function initBoard() {
                for (let r = 0; r < ROWS; r++) {
                    board[r] = Array(COLS).fill('empty');
                }
            }

            // Draws the game board (fixed pieces)
            function drawBoard() {
                ctx.clearRect(0, 0, canvas.width, canvas.height); // Clear the canvas
                for (let r = 0; r < ROWS; r++) {
                    for (let c = 0; c < COLS; c++) {
                        if (board[r][c] !== 'empty') {
                            ctx.fillStyle = board[r][c];
                            ctx.fillRect(c * BLOCK_SIZE, r * BLOCK_SIZE, BLOCK_SIZE, BLOCK_SIZE);
                            ctx.strokeStyle = '#fff';
                            ctx.lineWidth = 1;
                            ctx.strokeRect(c * BLOCK_SIZE, r * BLOCK_SIZE, BLOCK_SIZE, BLOCK_SIZE);
                        }
                    }
                }
            }

            // Shows a combo message (Double, Triple, Tetris)
            function displayComboMessage(message) {
                comboMessageElement.textContent = message;
                comboMessageElement.classList.add('show');
                setTimeout(() => {
                    comboMessageElement.classList.remove('show');
                }, 700); // Message disappears after 0.7 seconds
            }

            // Jokes for when the player levels up
            const levelUpJokes = [
                "¬øQu√© le dice un Tetris a otro? ¬°Deja de apilarte, que me ahogo!",
                "¬øPor qu√© el Tetris nunca gana en un debate? ¬°Siempre se queda bloqueado!",
                "Un Tetris entra a un bar... y le dicen: 'Lo siento, aqu√≠ no se permiten piezas sueltas'.",
                "¬øCu√°l es el colmo de un Tetris? ¬°Que se le caigan todas las l√≠neas!",
                "Mi vida es como un Tetris: si todo encaja, desaparece.",
                "¬øQu√© hace un Tetris en el gimnasio? ¬°Forma cubos!",
                "¬øPor qu√© los Tetris son buenos en matem√°ticas? ¬°Porque siempre est√°n calculando √°ngulos!",
                "Mi psic√≥logo me dijo que mi ansiedad se deb√≠a a un juego de Tetris mal resuelto en mi pasado.",
                "¬øQu√© es un Tetris bailando? ¬°Un baile de bloques!",
                "¬°Felicidades! Has superado otro nivel, ahora el juego se pone m√°s... en l√≠nea.",
                "¬øPor qu√© el l√°piz se deprimi√≥? Porque estaba muy atilado.",
                "¬øQu√© le dice una pared a otra pared? ¬°Nos vemos en la esquina!",
                "¬øQu√© hace una computadora en la playa? Busca un mouse playero.",
                "¬øC√≥mo se llama el hermano mayor de un tomate? ¬°Tomat√≥n!",
                "¬øPor qu√© el perro no puede jugar a las cartas? Porque siempre se sienta sobre las barajas."
            ];

            // Shows a message and a joke when leveling up
            function displayLevelUpMessage() {
                const randomIndex = Math.floor(Math.random() * levelUpJokes.length);
                levelUpMessageElement.innerHTML = `¬°Nivel ${level}! <br>` + levelUpJokes[randomIndex];
                levelUpMessageElement.classList.add('show');
            }

            // Main game loop
            function gameLoop(currentTime) {
                gameLoopId = requestAnimationFrame(gameLoop); // Request the next animation frame
                if (gameOver || isPaused || !gameStarted) return; // If the game is over, paused or not started, do nothing

                // Control piece falling based on time interval
                if (currentTime - lastUpdateTime > currentFallInterval) {
                    if (!currentPiece.move(0, 1)) { // Try to move the piece down
                        currentPiece.lock(); // If it can't, lock it
                    }
                    lastUpdateTime = currentTime; // Update the last fall time
                }

                drawBoard(); // Draw the board
                currentPiece.draw(); // Draw the falling piece
            }

            // Starts or restarts the game
            function startGame() {
                initBoard(); // Initialize the board
                score = 0; level = 1; linesClearedTotal = 0; // Reset score, level and lines
                currentFallInterval = BASE_FALL_INTERVAL; nextLevelScoreThreshold = 500; // Reset intervals and thresholds
                isPaused = false; gameOver = false; gameStarted = true; // Reset game states

                scoreDisplay.textContent = score; // Update UI
                levelDisplay.textContent = level;
                gameMessage.classList.add('hidden'); // Hide messages
                comboMessageElement.classList.remove('show');
                levelUpMessageElement.classList.remove('show');

                startButton.classList.add('hidden'); // Hide start button
                pauseButton.classList.remove('hidden'); // Show pause button
                pauseButton.textContent = "Pausar"; // Ensure button text is "Pausar"
                muteButton.textContent = "Silenciar M√∫sica"; // Reset mute button text
                isMuted = false; // Reset mute state
                
                COLORS = COLOR_PALETTES[0]; // Reset palette when starting a new game

                // Generate the first piece and the next one
                currentPiece = new Piece(Object.keys(TETROMINO_SHAPES)[Math.floor(Math.random() * Object.keys(TETROMINO_SHAPES).length)]);
                nextPiece = new Piece(Object.keys(TETROMINO_SHAPES)[Math.floor(Math.random() * Object.keys(TETROMINO_SHAPES).length)]);
                currentPiece.drawNextPiece(); // Draw the next piece preview
                lastUpdateTime = performance.now(); // Set the start time for the fall loop

                if (gameLoopId) { cancelAnimationFrame(gameLoopId); } // Cancel any previous loop
                gameLoopId = requestAnimationFrame(gameLoop); // Start the game loop

                // Start background music only if not muted
                if (!isMuted) {
                    Tone.Transport.start();
                    sailorMoonMelody.start();
                }
            }

            // Stops background music
            function stopBackgroundMusic() {
                sailorMoonMelody.stop();
                Tone.Transport.stop();
            }

            // Keyboard event handling
            document.addEventListener('keydown', e => {
                if (!gameStarted) return; // Do nothing if the game has not started
                if (gameOver) {
                    if (e.key === 'Enter') { startGame(); } // Restart the game if Game Over and Enter is pressed
                    return;
                }
                if (isPaused && e.key !== 'p' && e.key !== 'P') return; // Only allow pause/resume if paused

                switch (e.key) {
                    case 'ArrowLeft': currentPiece.move(-1, 0); break; // Move left
                    case 'ArrowRight': currentPiece.move(1, 0); break; // Move right
                    case 'ArrowDown': currentPiece.move(0, 1); break; // Move down (soft drop)
                    case 'ArrowUp': currentPiece.rotate(); break; // Rotate
                    case ' ': while (currentPiece.move(0, 1)); currentPiece.lock(); break; // Instant drop (hard drop)
                    case 'p': case 'P': togglePause(); break; // Pause/Resume
                }
                if (!isPaused) {
                    drawBoard(); // Redraw the board after movement
                    currentPiece.draw(); // Redraw the piece
                }
            });

            // Variables for touch control
            let touchStartX = 0;
            let touchStartY = 0;
            const tapThreshold = 8; // Threshold to recognize a tap
            const swipeThreshold = 20; // Threshold to recognize a swipe
            const hardDropSwipeThreshold = 70; // Threshold to recognize a long swipe for hard drop

            // Touch event handling
            canvas.addEventListener('touchstart', e => {
                e.preventDefault(); // Prevent default browser scrolling
                if (!gameStarted || gameOver || isPaused) return;
                touchStartX = e.touches[0].clientX;
                touchStartY = e.touches[0].clientY;
            });

            canvas.addEventListener('touchmove', e => { e.preventDefault(); }); // Prevent scrolling during touch move

            canvas.addEventListener('touchend', e => {
                if (!gameStarted || gameOver || isPaused) return;
                const touchEndX = e.changedTouches[0].clientX;
                const touchEndY = e.changedTouches[0].clientY;
                const deltaX = touchEndX - touchStartX;
                const deltaY = touchEndY - touchStartY;
                const isTap = Math.abs(deltaX) < tapThreshold && Math.abs(deltaY) < tapThreshold;

                if (isTap) {
                    currentPiece.rotate(); // A simple tap rotates the piece
                } else {
                    if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > swipeThreshold) {
                        // Horizontal swipe
                        if (deltaX < 0) { currentPiece.move(-1, 0); } // Swipe left
                        else { currentPiece.move(1, 0); } // Swipe right
                    } else if (Math.abs(deltaY) > Math.abs(deltaX) && Math.abs(deltaY) > swipeThreshold) {
                        // Vertical swipe
                        if (deltaY > 0) {
                            if (Math.abs(deltaY) > hardDropSwipeThreshold) {
                                while (currentPiece.move(0, 1)); // Instant drop if swipe is long
                                currentPiece.lock();
                            } else {
                                currentPiece.move(0, 1); // Soft drop if swipe is short
                            }
                        }
                    }
                }
                drawBoard(); // Redraw the board
                currentPiece.draw(); // Redraw the piece
            });

            // Toggles the game's pause state
            function togglePause() {
                if (!gameStarted || gameOver) return; // Cannot pause if game has not started or is over
                isPaused = !isPaused; // Invert pause state
                if (isPaused) {
                    pauseButton.textContent = "Reanudar"; // Change button text
                    gameMessage.textContent = '¬°Juego Pausado!'; // Show pause message
                    gameMessage.classList.remove('hidden');
                    cancelAnimationFrame(gameLoopId); // Stop animation loop
                    sailorMoonMelody.stop(); // Pause background music
                } else {
                    pauseButton.textContent = "Pausar"; // Change button text
                    gameMessage.classList.add('hidden'); // Hide pause message
                    levelUpMessageElement.classList.remove('show'); // Hide level message (if visible)
                    lastUpdateTime = performance.now(); // Reset time for correct fall
                    gameLoop(performance.now()); // Resume game loop
                    if (!isMuted) { // Only resume music if not globally muted
                        sailorMoonMelody.start(); // Resume background music
                    }
                }
            }

            // Toggles the music mute state
            function toggleMute() {
                isMuted = !isMuted; // Invert mute state
                if (isMuted) {
                    muteButton.textContent = "Activar M√∫sica"; // Change button text
                    sailorMoonMelody.stop(); // Stop background music
                    Tone.Transport.stop(); // Stop Tone.js transport
                } else {
                    muteButton.textContent = "Silenciar M√∫sica"; // Change button text
                    if (gameStarted && !gameOver && !isPaused) { // Only start music if game is active
                        Tone.Transport.start();
                        sailorMoonMelody.start(); // Start background music
                    }
                }
            }

            // Event listener for the pause button
            pauseButton.addEventListener('click', togglePause);

            // Event listener for the start/restart button
            startButton.addEventListener('click', () => {
                if (gameOver || !gameStarted) {
                    startGame(); // Start a new game if Game Over or not started
                } else if (isPaused) {
                    togglePause(); // Resume game if paused
                }
            });

            // Event listener for the mute button
            muteButton.addEventListener('click', toggleMute);

            // Public module functions for external access
            return {
                startGame: startGame,
                togglePause: togglePause,
                isPaused: () => isPaused,
                gameOver: () => gameOver,
                gameStarted: () => gameStarted,
                stopBackgroundMusic: stopBackgroundMusic // Expose function to stop music
            };
        })();


        // --- CROSSWORD GAME LOGIC ---
        // Core variables and constants
        let _answers = [];
        let _vword = "";
        let _refs = [];
        let numberOfInputs = 0; // Total number of fillable inputs
        let originalColors = {};

        // DOM elements
        const CPUZZLE_CONTAINER = document.getElementById('cpuzzle');
        const REFERENCES_CONTAINER = document.getElementById('references');
        
        const levelSelectionDiv = document.getElementById('level-selection');
        const gameAreaDiv = document.getElementById('game-area');
        const crosswordTitle = document.getElementById('crossword-title');
        const scoreDisplay = document.getElementById('score-display');
        const crosswordCounter = document.getElementById('crossword-counter');
        const nextCrosswordBtn = document.getElementById('next-crossword-btn');
        const restartGameBtn = document.getElementById('restart-game-btn');
        const revealLetterBtn = document.getElementById('reveal-letter-btn');
        const menuBtn = document.getElementById('menu-btn');
        const configBtn = document.getElementById('config-btn');
        const progressBar = document.querySelector('.progress-bar');
        const messageDisplay = document.getElementById('message-display');
        const successModal = new bootstrap.Modal(document.getElementById('successModal'));

        // --- Tone.js Synths for Crossword ---
        const correctSynth = new Tone.Synth().toDestination();
        const wrongSynth = new Tone.NoiseSynth({
            noise: { type: 'brown' },
            envelope: { attack: 0.005, decay: 0.1, sustain: 0.01, release: 0.1 }
        }).toDestination();
        const revealSynth = new Tone.FMSynth().toDestination();
        const crosswordCompleteSynth = new Tone.PolySynth(Tone.Synth, {
            oscillator: { type: "square" },
            envelope: { attack: 0.01, decay: 0.2, sustain: 0.1, release: 0.3 }
        }).toDestination();

        // Game state variables
        let currentLevel = '';
        let currentCrosswordIndex = 0;
        let currentCrosswordsForLevel = [];
        let totalScore = 0; // Overall game score across all puzzles

        // Timeout for message display
        let messageTimeout;

        // Data structure for crosswords
        const crucigramas = {
            "facil": {
                // Width: 10, Height: 10, Words from 5 to 10 letters
                "Crucigrama 1 F": {
                    "ancho": 10, "alto": 10,
                    "vword": "CULTURA", // 7 letters
                    "answers": [
                        "ARTE",         // C
                        "MUSICA",       // U
                        "LIBRO",        // L
                        "TRADICION",    // T
                        "IDIOMA",       // U
                        "RITO",         // R
                        "SABER"         // A
                    ],
                    "refs": [
                        "Expresi√≥n de la creatividad humana",
                        "Arte de los sonidos organizados",
                        "Conjunto de hojas escritas",
                        "Costumbre transmitida",
                        "Sistema de comunicaci√≥n verbal",
                        "Ceremonia o costumbre",
                        "Conocimiento profundo"
                    ]
                },
                "Crucigrama 2 F": {
                    "ancho": 10, "alto": 10,
                    "vword": "TECNICO", // 7 letters
                    "answers": [
                        "REDES",        // T
                        "EQUIPO",       // E
                        "SOFTWARE",     // C
                        "ORDENADOR",    // N
                        "INTERNET",     // I
                        "CODIGO",       // C
                        "OPERAR"        // O
                    ],
                    "refs": [
                        "Conjunto de conexiones",
                        "Conjunto de aparatos",
                        "Programas inform√°ticos",
                        "M√°quina para procesar datos",
                        "Red global de comunicaci√≥n",
                        "Conjunto de instrucciones",
                        "Manejar o funcionar"
                    ]
                },
                "Crucigrama 3 F": {
                    "ancho": 10, "alto": 10,
                    "vword": "MUSICA", // 6 letters
                    "answers": [
                        "RITMO",        // M
                        "NOTA",         // U
                        "CANTO",        // S
                        "INSTRUMENTO",  // I
                        "PIANO",        // C
                        "MELODIA"       // A
                    ],
                    "refs": [
                        "Patr√≥n de sonidos",
                        "Signo de sonido",
                        "Acci√≥n de cantar",
                        "Objeto para producir sonidos",
                        "Instrumento de teclado",
                        "Serie de sonidos agradables"
                    ]
                },
                "Crucigrama 4 F": {
                    "ancho": 10, "alto": 10,
                    "vword": "SALUD", // 5 letters
                    "answers": [
                        "BIENESTAR",    // S
                        "MEDICO",       // A
                        "DEPORTE",      // L
                        "DIETA",        // U
                        "MENTE"         // D
                    ],
                    "refs": [
                        "Estado de sentirse bien",
                        "Profesional de la medicina",
                        "Actividad f√≠sica",
                        "R√©gimen alimenticio",
                        "Facultad de pensar"
                    ]
                },
                "Crucigrama 5 F": {
                    "ancho": 10, "alto": 10,
                    "vword": "VIAJE", // 5 letters
                    "answers": [
                        "AVION",        // V
                        "ISLA",         // I
                        "AVENTURA",     // A
                        "RUMBO",        // J
                        "DESTINO"       // E
                    ],
                    "refs": [
                        "Aeronave",
                        "Tierra rodeada de agua",
                        "Experiencia emocionante",
                        "Direcci√≥n que se toma",
                        "Lugar al que se llega"
                    ]
                }
            },
            "medio": {
                // Width: 20, Height: 20, Words up to 15 letters
                "Crucigrama 1 M": {
                    "ancho": 20, "alto": 20,
                    "vword": "HISTORIA", // 8 letters
                    "answers": [
                        "ANTIGUEDAD",       // H
                        "DESCUBRIMIENTO",   // I
                        "SUCESO",           // S
                        "TIEMPO",           // T
                        "ORIGEN",           // O
                        "REVOLUCION",       // R
                        "INVESTIGACION",    // I
                        "ARQUEOLOGIA"       // A
                    ],
                    "refs": [
                        "Periodo muy remoto",
                        "Hallazgo de algo nuevo",
                        "Acontecimiento o hecho",
                        "Magnitud de duraci√≥n",
                        "Principio o comienzo",
                        "Cambio profundo y r√°pido",
                        "B√∫squeda de conocimiento",
                        "Estudio de las civilizaciones antiguas"
                    ]
                },
                "Crucigrama 2 M": {
                    "ancho": 20, "alto": 20,
                    "vword": "BIOLOGIA", // 8 letters
                    "answers": [
                        "CELULA",           // B
                        "ORGANISMO",        // I
                        "DIVERSIDAD",       // O
                        "GENETICA",         // L
                        "ECOLOGIA",         // O
                        "PLANTAS",          // G
                        "ANIMALES",         // I
                        "ADAPTACION"        // A
                    ],
                    "refs": [
                        "Unidad b√°sica de la vida",
                        "Ser vivo complejo",
                        "Variedad de especies",
                        "Estudio de la herencia",
                        "Estudio de los ecosistemas",
                        "Seres vivos fotosint√©ticos",
                        "Seres vivos que se mueven",
                        "Ajuste al ambiente"
                    ]
                },
                "Crucigrama 3 M": {
                    "ancho": 20, "alto": 20,
                    "vword": "ECONOMIA", // 8 letters
                    "answers": [
                        "FINANZAS",         // E
                        "COMERCIO",         // C
                        "PRODUCCION",       // O
                        "MERCADO",          // N
                        "INDUSTRIA",        // O
                        "RECURSOS",         // M
                        "AHORRO",           // I
                        "EMPRESA"           // A
                    ],
                    "refs": [
                        "Gesti√≥n de dinero",
                        "Intercambio de bienes",
                        "Elaboraci√≥n de productos",
                        "Lugar de compra y venta",
                        "Conjunto de f√°bricas",
                        "Bienes disponibles",
                        "Guardar dinero",
                        "Organizaci√≥n con fines de lucro"
                    ]
                },
                "Crucigrama 4 M": {
                    "ancho": 20, "alto": 20,
                    "vword": "GEOGRAFIA", // 9 letters
                    "answers": [
                        "MAPA",             // G
                        "RELIEVE",          // E
                        "OCEANOS",          // O
                        "CLIMA",            // G
                        "REGION",           // R
                        "PAISAJE",          // A
                        "FRONTERA",         // F
                        "POBLACION",        // I
                        "TERRITORIO"        // A
                    ],
                    "refs": [
                        "Representaci√≥n gr√°fica de la tierra",
                        "Formas de la superficie terrestre",
                        "Grandes masas de agua salada",
                        "Condiciones atmosf√©ricas",
                        "Zona delimitada",
                        "Vista del terreno",
                        "L√≠mite entre pa√≠ses",
                        "Conjunto de habitantes",
                        "Extensi√≥n de tierra"
                    ]
                },
                "Crucigrama 5 M": {
                    "ancho": 20, "alto": 20,
                    "vword": "FILOSOFIA", // 9 letters
                    "answers": [
                        "PENSAMIENTO",      // F
                        "LOGICA",           // I
                        "RAZON",            // L
                        "CONOCIMIENTO",     // O
                        "SABIDURIA",        // S
                        "ETICA",            // O
                        "MORAL",            // F
                        "IDEAS",            // I
                        "VALORES"           // A
                    ],
                    "refs": [
                        "Acto de pensar",
                        "Estudio del razonamiento v√°lido",
                        "Capacidad de reflexionar",
                        "Informaci√≥n y entendimiento",
                        "Conocimiento profundo",
                        "Principios del bien y el mal",
                        "Normas de conducta",
                        "Conceptos o representaciones",
                        "Principios de conducta"
                    ]
                }
            },
            "dificil": {
                // Width: 20, Height: 20, More difficult words
                "Crucigrama 1 D": {
                    "ancho": 20, "alto": 20,
                    "vword": "PARADIGMA", // 9 letters
                    "answers": [
                        "CONCEPCION",       // P
                        "MODELO",           // A
                        "REVOLUCION",       // R
                        "ANALOGIA",         // A
                        "DESARROLLO",       // D
                        "INVESTIGACION",    // I
                        "GLOBALIZACION",    // G
                        "HEGEMONIA",        // M
                        "SINTESIS"          // A
                    ],
                    "refs": [
                        "Idea o modo de entender",
                        "Ejemplo a seguir",
                        "Cambio profundo",
                        "Relaci√≥n de semejanza",
                        "Proceso de crecimiento o mejora",
                        "B√∫squeda sistem√°tica de conocimiento",
                        "Expansi√≥n a nivel mundial",
                        "Supremac√≠a o dominio",
                        "Composici√≥n de un todo por la uni√≥n de sus partes"
                    ]
                },
                "Crucigrama 2 D": {
                    "ancho": 20, "alto": 20,
                    "vword": "EPISTEME", // 8 letters
                    "answers": [
                        "CONOCIMIENTO",     // E
                        "CIENCIA",          // P
                        "RAZONAMIENTO",     // I
                        "TEORIA",           // S
                        "VERIFICACION",     // T
                        "EXPLICACION",      // E
                        "METODOLOGIA",      // M
                        "DISCURSO"          // E
                    ],
                    "refs": [
                        "Saber adquirido",
                        "Rama del saber humano",
                        "Proceso mental l√≥gico",
                        "Conjunto de hip√≥tesis que explican un fen√≥meno",
                        "Comprobaci√≥n de la verdad",
                        "Justificaci√≥n o aclaraci√≥n",
                        "Estudio de los m√©todos",
                        "Serie de palabras o razonamientos"
                    ]
                },
                "Crucigrama 3 D": {
                    "ancho": 20, "alto": 20,
                    "vword": "HEURISTICA", // 10 letters
                    "answers": [
                        "DESCUBRIR",        // H
                        "EXPLORACION",      // E
                        "INNOVACION",       // U
                        "CREATIVIDAD",      // R
                        "INTUICION",        // I
                        "SOLUCION",         // S
                        "ALGORITMO",        // T
                        "INSPIRACION",      // I
                        "CONJETURA",        // C
                        "ESTRATEGIA"        // A
                    ],
                    "refs": [
                        "Hallar lo desconocido",
                        "Investigaci√≥n de un lugar",
                        "Acci√≥n de introducir novedades",
                        "Capacidad de crear",
                        "Percepci√≥n clara e instant√°nea",
                        "Respuesta a un problema",
                        "Conjunto de reglas para resolver un problema",
                        "Est√≠mulo creativo",
                        "Suposici√≥n probable",
                        "Plan para lograr un objetivo"
                    ]
                },
                "Crucigrama 4 D": {
                    "ancho": 20, "alto": 20,
                    "vword": "COGNICION", // 9 letters
                    "answers": [
                        "PERCEPCION",       // C
                        "RAZONAMIENTO",     // O
                        "APRENDIZAJE",      // G
                        "MEMORIA",          // N
                        "IMAGINACION",      // I
                        "LENGUAJE",         // C
                        "PENSAMIENTO",      // I
                        "COMPRENSION",      // O
                        "DECISION"          // N
                    ],
                    "refs": [
                        "Proceso de interpretar informaci√≥n sensorial",
                        "Capacidad de l√≥gica",
                        "Adquisici√≥n de conocimientos",
                        "Capacidad de recordar",
                        "Creaci√≥n de im√°genes mentales",
                        "Sistema de comunicaci√≥n",
                        "Proceso mental de ideas",
                        "Entendimiento de algo",
                        "Elecci√≥n entre alternativas"
                    ]
                },
                "Crucigrama 5 D": {
                    "ancho": 20, "alto": 20,
                    "vword": "ONTOLOGIA", // 9 letters
                    "answers": [
                        "EXISTENCIA",       // O
                        "REALIDAD",         // N
                        "SER",              // T
                        "NATURALEZA",       // O
                        "METAFIZICA",       // L
                        "UNIVERSO",         // O
                        "ESENCIA",          // G
                        "VERDAD",           // I
                        "FENOMENO"          // A
                    ],
                    "refs": [
                        "Hecho de ser o existir",
                        "Lo que es verdadero y efectivo",
                        "Lo que tiene vida o existencia",
                        "Conjunto de todo lo natural",
                        "Rama de la filosof√≠a que estudia los principios de la realidad",
                        "Conjunto de todo lo creado",
                        "Lo que constituye la naturaleza de algo",
                        "Conformidad con los hechos",
                        "Manifestaci√≥n observable"
                    ]
                }
            }
        };

        /**
         * Draws the crossword grid based on the vertical word and horizontal answers.
         * @param {string} vword - The vertical word.
         * @param {string[]} ans - Array of horizontal words.
         * @param {boolean} showAnswers - If true, pre-fills the answers.
         * @param {number} crosswordWidth - The desired width of the crossword grid.
         * @param {number} crosswordHeight - The desired height of the crossword grid.
         */
        function drawCrossword(vword, ans, showAnswers, crosswordWidth, crosswordHeight) {
            let html = `<form><table class="crossword-table">`;
            numberOfInputs = 0; // Reset for new crossword

            // Calculate dynamic center column based on current crossword width
            const centerColumn = Math.floor(crosswordWidth / 2);

            // Loop through rows based on crosswordHeight
            for (let i = 0; i < crosswordHeight; i++) {
                html += '<tr>';
                
                // Ensure vword[i] exists for the current row
                const currentVWordChar = (i < vword.length) ? vword[i].toLowerCase() : '';
                // Ensure ans[i] exists for the current row
                const currentAnsWord = (i < ans.length) ? ans[i].toLowerCase() : '';

                let intersectionIndex = -1;
                // Only try to find intersection if both vertical char and horizontal word exist
                if (currentVWordChar && currentAnsWord) {
                    intersectionIndex = currentAnsWord.indexOf(currentVWordChar);
                }
                
                // Calculate the starting position for the horizontal word to align its intersection with `centerColumn`
                let initPosition;
                if (intersectionIndex !== -1) {
                    initPosition = centerColumn - intersectionIndex;
                } else {
                    // If no intersection, center the word or place it at a default offset
                    initPosition = centerColumn - Math.floor(currentAnsWord.length / 2);
                }
                
                // Loop through columns based on crosswordWidth
                for (let j = 0; j < crosswordWidth; j++) {
                    const isVerticalWordCell = (j === centerColumn && i < vword.length);
                    const isHorizontalWordCell = (j >= initPosition && j < initPosition + currentAnsWord.length && currentAnsWord.length > 0);
                    
                    let charToFill = '';
                    let tdClass = '';
                    let inputClass = '';
                    let isDisabled = '';
                    
                    if (isVerticalWordCell && isHorizontalWordCell) {
                        // Intersection cell
                        charToFill = vword[i].toUpperCase();
                        tdClass = 'table-primary'; // Vertical word color
                        isDisabled = 'disabled'; // Disable input for intersection cells
                        inputClass = 'text-center'; // Ensure text is centered
                    } else if (isVerticalWordCell) {
                        // Vertical word only cell
                        charToFill = vword[i].toUpperCase();
                        tdClass = 'table-primary';
                        isDisabled = 'disabled';
                        inputClass = 'text-center';
                    } else if (isHorizontalWordCell) {
                        // Horizontal word only cell
                        charToFill = currentAnsWord[j - initPosition].toUpperCase();
                        tdClass = 'table-secondary'; // Fillable cell background
                        numberOfInputs++; // Count as a fillable input
                    } else {
                        // Empty cell (black cell equivalent)
                        tdClass = 'bg-gray-800'; // Dark background for empty cells
                        isDisabled = 'disabled';
                    }

                    html += `<td class="${tdClass} crossword-cell" data-row="${i}" data-col="${j}">`;
                    if (tdClass !== 'bg-gray-800') { // Only add input for non-black cells
                        const value = showAnswers ? charToFill : '';
                        html += `<input type="text" maxlength="1" data-row="${i}" data-col="${j}" class="${inputClass}" value="${value}" ${isDisabled}>`;
                    }
                    html += `</td>`;
                }
                html += '</tr>';
            }
            
            html += `</table></form>`;
            CPUZZLE_CONTAINER.innerHTML = html;

            // Add event listeners for inputs
            CPUZZLE_CONTAINER.querySelectorAll('input').forEach(input => {
                input.addEventListener('input', checkAnswer);
                input.addEventListener('keydown', handleInputNavigation);
                input.addEventListener('focus', handleCellFocus);
                input.addEventListener('blur', handleCellBlur);
            });
        }

        /**
         * Renders the hints for the current crossword puzzle.
         */
        function drawReferences() {
            REFERENCES_CONTAINER.innerHTML = '';
            _refs.forEach((ref, index) => {
                const li = document.createElement('li');
                li.id = `hint-${index}`; // Add an ID for easy reference
                li.textContent = `${index + 1}. ${ref}`;
                REFERENCES_CONTAINER.appendChild(li);
            });
        }

        /**
         * Checks the entered answer and updates the UI.
         */
        function checkAnswer(event) {
            const input = event.target;
            const row = parseInt(input.dataset.row);
            const col = parseInt(input.dataset.col);
            const enteredChar = input.value.toUpperCase();

            // Find the character from the vertical word
            const centerColumn = Math.floor(currentCrosswordsForLevel[currentCrosswordIndex].ancho / 2);
            const vwordChar = (col === centerColumn && row < _vword.length) ? _vword[row].toUpperCase() : null;

            // Find the character from the horizontal word
            let hwordChar = null;
            const currentAnsWord = currentCrosswordsForLevel[currentCrosswordIndex].answers[row];
            if (currentAnsWord) {
                const currentVWordCharForHWord = (row < _vword.length) ? _vword[row].toLowerCase() : '';
                const intersectionIndex = currentAnsWord.toLowerCase().indexOf(currentVWordCharForHWord);
                let initPosition;
                if (intersectionIndex !== -1) {
                    initPosition = centerColumn - intersectionIndex;
                } else {
                    initPosition = centerColumn - Math.floor(currentAnsWord.length / 2);
                }

                if (col >= initPosition && col < initPosition + currentAnsWord.length) {
                    hwordChar = currentAnsWord[col - initPosition].toUpperCase();
                }
            }

            // Determine the correct character for this cell
            let correctChar = '';
            if (vwordChar && hwordChar && vwordChar === hwordChar) {
                correctChar = vwordChar; // It's an intersection, character must match
            } else if (vwordChar) {
                correctChar = vwordChar; // Only vertical word
            } else if (hwordChar) {
                correctChar = hwordChar; // Only horizontal word
            }

            if (enteredChar === correctChar) {
                input.classList.remove('wrong-answer');
                input.classList.add('correct-answer');
                correctSynth.triggerAttackRelease("C5", "16n"); // Play correct sound
            } else {
                input.classList.remove('correct-answer');
                input.classList.add('wrong-answer');
                wrongSynth.triggerAttackRelease("8n"); // Play wrong sound
            }

            updateProgressBar();
            checkCrosswordCompletion(); // Check if the crossword is complete after each input
        }


        /**
         * Handles keyboard navigation for input cells.
         * @param {KeyboardEvent} event
         */
        function handleInputNavigation(event) {
            const input = event.target;
            const row = parseInt(input.dataset.row);
            const col = parseInt(input.dataset.col);

            let nextInput = null;

            switch (event.key) {
                case 'ArrowRight':
                    nextInput = CPUZZLE_CONTAINER.querySelector(`input[data-row="${row}"][data-col="${col + 1}"]`);
                    break;
                case 'ArrowLeft':
                    nextInput = CPUZZLE_CONTAINER.querySelector(`input[data-row="${row}"][data-col="${col - 1}"]`);
                    break;
                case 'ArrowDown':
                    nextInput = CPUZZLE_CONTAINER.querySelector(`input[data-row="${row + 1}"][data-col="${col}"]`);
                    break;
                case 'ArrowUp':
                    nextInput = CPUZZLE_CONTAINER.querySelector(`input[data-row="${row - 1}"][data-col="${col}"]`);
                    break;
                case 'Enter':
                    event.preventDefault(); // Prevent form submission
                    checkCrosswordCompletion(); // Check completion on Enter
                    break;
            }

            if (nextInput && !nextInput.disabled) {
                nextInput.focus();
                nextInput.select(); // Select the text for easier overwriting
            }
        }

        /**
         * Highlights the word associated with the focused cell and its hint.
         * @param {FocusEvent} event
         */
        function handleCellFocus(event) {
            const input = event.target;
            const row = parseInt(input.dataset.row);
            const col = parseInt(input.dataset.col);

            // Remove existing highlights
            CPUZZLE_CONTAINER.querySelectorAll('.crossword-cell.highlighted').forEach(cell => {
                cell.classList.remove('highlighted');
            });
            REFERENCES_CONTAINER.querySelectorAll('.hint-highlighted').forEach(hint => {
                hint.classList.remove('hint-highlighted');
            });

            const crosswordData = currentCrosswordsForLevel[currentCrosswordIndex];
            const centerColumn = Math.floor(crosswordData.ancho / 2);

            // Highlight horizontal word and hint
            const hword = crosswordData.answers[row];
            if (hword) {
                const vwordCharForHWord = (row < _vword.length) ? _vword[row].toLowerCase() : '';
                const intersectionIndex = hword.toLowerCase().indexOf(vwordCharForHWord);
                let initPosition;
                if (intersectionIndex !== -1) {
                    initPosition = centerColumn - intersectionIndex;
                } else {
                    initPosition = centerColumn - Math.floor(hword.length / 2);
                }

                for (let c = 0; c < hword.length; c++) {
                    const cell = CPUZZLE_CONTAINER.querySelector(`td[data-row="${row}"][data-col="${initPosition + c}"]`);
                    if (cell) {
                        cell.classList.add('highlighted');
                    }
                }
                const hint = REFERENCES_CONTAINER.querySelector(`#hint-${row}`);
                if (hint) {
                    hint.classList.add('hint-highlighted');
                }
            }

            // Highlight vertical word and hint (if applicable)
            if (col === centerColumn) {
                for (let r = 0; r < _vword.length; r++) {
                    const cell = CPUZZLE_CONTAINER.querySelector(`td[data-row="${r}"][data-col="${col}"]`);
                    if (cell) {
                        cell.classList.add('highlighted');
                    }
                }
                // The vertical word doesn't have a direct hint by index, so we can skip highlighting a specific hint for it
                // Or you could add a special 'vertical' hint if desired in the data structure
            }
        }

        /**
         * Removes highlights when a cell loses focus.
         */
        function handleCellBlur() {
            CPUZZLE_CONTAINER.querySelectorAll('.crossword-cell.highlighted').forEach(cell => {
                cell.classList.remove('highlighted');
            });
            REFERENCES_CONTAINER.querySelectorAll('.hint-highlighted').forEach(hint => {
                hint.classList.remove('hint-highlighted');
            });
        }

        /**
         * Updates the progress bar based on the number of correct answers.
         */
        function updateProgressBar() {
            let correctCount = 0;
            CPUZZLE_CONTAINER.querySelectorAll('input').forEach(input => {
                const row = parseInt(input.dataset.row);
                const col = parseInt(input.dataset.col);

                // Determine the correct character based on both vertical and horizontal words
                const centerColumn = Math.floor(currentCrosswordsForLevel[currentCrosswordIndex].ancho / 2);
                let correctCharForCell = '';

                // Check vertical word char
                const vwordCharForCell = (col === centerColumn && row < _vword.length) ? _vword[row].toUpperCase() : null;

                // Check horizontal word char
                let hwordCharForCell = null;
                const currentAnsWord = currentCrosswordsForLevel[currentCrosswordIndex].answers[row];
                if (currentAnsWord) {
                    const vwordCharForHWord = (row < _vword.length) ? _vword[row].toLowerCase() : '';
                    const intersectionIndex = currentAnsWord.toLowerCase().indexOf(vwordCharForHWord);
                    let initPosition;
                    if (intersectionIndex !== -1) {
                        initPosition = centerColumn - intersectionIndex;
                    } else {
                        initPosition = centerColumn - Math.floor(currentAnsWord.length / 2);
                    }
                    
                    if (col >= initPosition && col < initPosition + currentAnsWord.length) {
                        hwordCharForCell = currentAnsWord[col - initPosition].toUpperCase();
                    }
                }

                if (vwordCharForCell && hwordCharForCell && vwordCharForCell === hwordCharForCell) {
                    correctCharForCell = vwordCharForCell; // Intersection
                } else if (vwordCharForCell) {
                    correctCharForCell = vwordCharForCell; // Only vertical
                } else if (hwordCharForCell) {
                    correctCharForCell = hwordCharForCell; // Only horizontal
                }

                if (input.value.toUpperCase() === correctCharForCell) {
                    correctCount++;
                }
            });

            const percentage = (correctCount / numberOfInputs) * 100;
            progressBar.style.width = `${percentage}%`;
            progressBar.setAttribute('aria-valuenow', percentage);
        }

        /**
         * Checks if the entire crossword is completed correctly.
         */
        function checkCrosswordCompletion() {
            let allFilledAndCorrect = true;
            CPUZZLE_CONTAINER.querySelectorAll('input').forEach(input => {
                const row = parseInt(input.dataset.row);
                const col = parseInt(input.dataset.col);

                const centerColumn = Math.floor(currentCrosswordsForLevel[currentCrosswordIndex].ancho / 2);
                let correctCharForCell = '';

                const vwordCharForCell = (col === centerColumn && row < _vword.length) ? _vword[row].toUpperCase() : null;

                let hwordCharForCell = null;
                const currentAnsWord = currentCrosswordsForLevel[currentCrosswordIndex].answers[row];
                if (currentAnsWord) {
                    const vwordCharForHWord = (row < _vword.length) ? _vword[row].toLowerCase() : '';
                    const intersectionIndex = currentAnsWord.toLowerCase().indexOf(vwordCharForHWord);
                    let initPosition;
                    if (intersectionIndex !== -1) {
                        initPosition = centerColumn - intersectionIndex;
                    } else {
                        initPosition = centerColumn - Math.floor(currentAnsWord.length / 2);
                    }
                    
                    if (col >= initPosition && col < initPosition + currentAnsWord.length) {
                        hwordCharForCell = currentAnsWord[col - initPosition].toUpperCase();
                    }
                }

                if (vwordCharForCell && hwordCharForCell && vwordCharForCell === hwordCharForCell) {
                    correctCharForCell = vwordCharForCell;
                } else if (vwordCharForCell) {
                    correctCharForCell = vwordCharForCell;
                } else if (hwordCharForCell) {
                    correctCharForCell = hwordCharForCell;
                }

                if (input.value.toUpperCase() !== correctCharForCell || input.value === '') {
                    allFilledAndCorrect = false;
                }
            });

            if (allFilledAndCorrect) {
                showMessage('¬°Crucigrama Completado!', 'text-green-600');
                successModal.show(); // Show Bootstrap success modal
                updateScore(100); // Award points for completion
                crosswordCompleteSynth.triggerAttackRelease(["C4", "E4", "G4", "C5"], "1n"); // Play completion sound
                nextCrosswordBtn.classList.remove('hidden'); // Show next crossword button
                restartGameBtn.classList.add('hidden'); // Hide restart button
                revealLetterBtn.classList.add('hidden'); // Hide reveal letter button
            }
        }

        /**
         * Displays a temporary message to the user.
         * @param {string} msg - The message to display.
         * @param {string} colorClass - Tailwind CSS class for text color (e.g., 'text-red-500', 'text-green-500').
         */
        function showMessage(msg, colorClass) {
            clearTimeout(messageTimeout); // Clear any existing timeout
            messageDisplay.textContent = msg;
            messageDisplay.className = `text-center font-medium mt-2 transition duration-300 ease-in-out ${colorClass}`;
            messageTimeout = setTimeout(() => {
                messageDisplay.textContent = '';
                messageDisplay.className = 'text-center font-medium mt-2 transition duration-300 ease-in-out';
            }, 3000); // Message disappears after 3 seconds
        }

        /**
         * Updates the player's total score.
         * @param {number} points - Points to add or subtract.
         */
        function updateScore(points) {
            totalScore += points;
            scoreDisplay.textContent = `Puntuaci√≥n: ${totalScore}`;
        }

        /**
         * Initializes a new crossword game for the given level and index.
         * @param {string} level - The difficulty level ('facil', 'medio', 'dificil').
         * @param {number} index - The index of the crossword puzzle within that level.
         */
        function initCrosswordGame(level, index) {
            currentLevel = level;
            currentCrosswordIndex = index;
            currentCrosswordsForLevel = Object.values(crucigramas[currentLevel]);

            if (index >= currentCrosswordsForLevel.length) {
                showMessage(`¬°Has completado todos los crucigramas ${currentLevel}!`, 'text-blue-600');
                nextCrosswordBtn.classList.add('hidden'); // No hay m√°s crucigramas en este nivel
                restartGameBtn.classList.add('hidden');
                revealLetterBtn.classList.add('hidden');
                return;
            }

            const currentCrosswordData = currentCrosswordsForLevel[currentCrosswordIndex];
            _vword = currentCrosswordData.vword;
            _answers = currentCrosswordData.answers;
            _refs = currentCrosswordData.refs;

            crosswordTitle.textContent = currentCrosswordData.name;
            crosswordCounter.textContent = `Crucigrama ${currentCrosswordIndex + 1} de ${currentCrosswordsForLevel.length}`;
            
            drawCrossword(_vword, _answers, false, currentCrosswordData.ancho, currentCrosswordData.alto);
            drawReferences();
            updateProgressBar(); // Reset progress bar
            showMessage('', ''); // Clear any previous messages

            nextCrosswordBtn.classList.add('hidden'); // Hide next crossword button initially
            restartGameBtn.classList.remove('hidden'); // Show restart button
            revealLetterBtn.classList.remove('hidden'); // Show reveal letter button

            levelSelectionDiv.classList.add('hidden'); // Hide level selection
            gameAreaDiv.classList.remove('hidden'); // Show game area
        }

        /**
         * Sets up event listeners for level selection buttons.
         */
        function setupLevelButtons() {
            document.getElementById('btn-facil').addEventListener('click', () => initCrosswordGame('facil', 0));
            document.getElementById('btn-medio').addEventListener('click', () => initCrosswordGame('medio', 0));
            document.getElementById('btn-dificil').addEventListener('click', () => initCrosswordGame('dificil', 0));
        }

        /**
         * Event listener for the "Next Crossword" button.
         */
        nextCrosswordBtn.addEventListener('click', () => {
            initCrosswordGame(currentLevel, currentCrosswordIndex + 1);
        });

        /**
         * Event listener for the "Restart Current Crossword" button.
         */
        restartGameBtn.addEventListener('click', () => {
            initCrosswordGame(currentLevel, currentCrosswordIndex); // Reload current crossword
            updateScore(-totalScore); // Reset score for the current crossword
            showMessage('Crucigrama reiniciado.', 'text-gray-500');
        });

        /**
         * Event listener for the "Reveal Letter" button.
         */
        revealLetterBtn.addEventListener('click', () => {
            if (totalScore < 10) {
                showMessage('No tienes suficientes puntos para revelar una letra (necesitas 10).', 'text-red-500');
                return;
            }

            const inputs = Array.from(CPUZZLE_CONTAINER.querySelectorAll('input:not([disabled]):not(.correct-answer)'));
            if (inputs.length > 0) {
                const randomIndex = Math.floor(Math.random() * inputs.length);
                const inputToReveal = inputs[randomIndex];
                const row = parseInt(inputToReveal.dataset.row);
                const col = parseInt(inputToReveal.dataset.col);

                // Determine the correct character for this cell
                const crosswordData = currentCrosswordsForLevel[currentCrosswordIndex];
                const centerColumn = Math.floor(crosswordData.ancho / 2);
                let correctChar = '';

                const vwordCharForCell = (col === centerColumn && row < _vword.length) ? _vword[row].toUpperCase() : null;

                let hwordCharForCell = null;
                const currentAnsWord = crosswordData.answers[row];
                if (currentAnsWord) {
                    const vwordCharForHWord = (row < _vword.length) ? _vword[row].toLowerCase() : '';
                    const intersectionIndex = currentAnsWord.toLowerCase().indexOf(vwordCharForHWord);
                    let initPosition;
                    if (intersectionIndex !== -1) {
                        initPosition = centerColumn - intersectionIndex;
                    } else {
                        initPosition = centerColumn - Math.floor(currentAnsWord.length / 2);
                    }
                    
                    if (col >= initPosition && col < initPosition + currentAnsWord.length) {
                        hwordCharForCell = currentAnsWord[col - initPosition].toUpperCase();
                    }
                }

                if (vwordCharForCell && hwordCharForCell && vwordCharForCell === hwordCharForCell) {
                    correctChar = vwordCharForCell;
                } else if (vwordCharForCell) {
                    correctChar = vwordCharForCell;
                } else if (hwordCharForCell) {
                    correctChar = hwordCharForCell;
                }
                
                inputToReveal.value = correctChar;
                inputToReveal.classList.add('correct-answer');
                inputToReveal.disabled = true; // Disable revealed letter
                updateScore(-10); // Subtract points
                revealSynth.triggerAttackRelease("G4", "8n"); // Play reveal sound
                updateProgressBar();
                showMessage('¬°Letra revelada!', 'text-yellow-500');
                checkCrosswordCompletion(); // Check completion after revealing a letter
            } else {
                showMessage('Todas las letras ya han sido reveladas o respondidas.', 'text-gray-500');
            }
        });

        /**
         * Event listener for the "Main Menu" button.
         */
        menuBtn.addEventListener('click', () => {
            showGamePortal();
            // Reset crossword game state for next time it's played
            levelSelectionDiv.classList.remove('hidden');
            gameAreaDiv.classList.add('hidden');
            totalScore = 0; // Reset overall score
            scoreDisplay.textContent = `Puntuaci√≥n: 0`;
            crosswordTitle.textContent = ''; // Clear title
            crosswordCounter.textContent = 'Crucigrama 0 de 5'; // Reset counter
            progressBar.style.width = '0%'; // Reset progress bar
            progressBar.setAttribute('aria-valuenow', 0);
            showMessage('', ''); // Clear messages
            nextCrosswordBtn.classList.add('hidden');
            restartGameBtn.classList.add('hidden');
            revealLetterBtn.classList.add('hidden');
        });

        // --- Color Configuration Modal Logic ---
        document.addEventListener('DOMContentLoaded', () => {
            const colorForm = document.getElementById('colorForm');
            if (colorForm) {
                const inputs = colorForm.querySelectorAll('input[type="color"]');
                inputs.forEach(input => {
                    originalColors[input.id] = input.value; // Save initial colors
                    input.addEventListener('input', (e) => {
                        document.documentElement.style.setProperty(`--${e.target.name}`, e.target.value);
                    });
                });
            }
        });

        function saveColors() {
            const colorForm = document.getElementById('colorForm');
            const inputs = colorForm.querySelectorAll('input[type="color"]');
            inputs.forEach(input => {
                // In a real application, you'd save these to localStorage or a database
                // For this example, colors are applied directly via CSS variables
            });
            // Dismiss the modal
            const configModal = bootstrap.Modal.getInstance(document.getElementById('configurationModal'));
            if (configModal) {
                configModal.hide();
            }
        }

        function reiniciarColores() {
            const colorForm = document.getElementById('colorForm');
            const inputs = colorForm.querySelectorAll('input[type="color"]');
            inputs.forEach(input => {
                input.value = originalColors[input.id]; // Reset input value
                document.documentElement.style.setProperty(`--${input.name}`, originalColors[input.id]); // Apply to CSS var
            });
        }


        // --- SIMPLE GAME WITH LEVELS LOGIC (Encapsulated) ---
        window.simpleGame = (() => {
            const simpleGameSection = document.getElementById('simple-game-section');
            const canvas = simpleGameSection.querySelector('#simpleGameCanvas');
            const ctx = canvas.getContext('2d');
            const startButton = simpleGameSection.querySelector('#simpleGameStartButton');
            const pauseButton = simpleGameSection.querySelector('#simpleGamePauseButton');
            const stopButton = simpleGameSection.querySelector('#simpleGameStopButton');
            const messageBox = simpleGameSection.querySelector('#simpleGameMessageBox');
            const messageText = simpleGameSection.querySelector('#simpleGameMessageText');
            const messageBoxButton = simpleGameSection.querySelector('#simpleGameMessageBoxButton');
            const levelDisplay = simpleGameSection.querySelector('#simpleGameLevelDisplay');
            const scoreDisplay = simpleGameSection.querySelector('#simpleGameScoreDisplay');
            const levelScoreDisplay = simpleGameSection.querySelector('#simpleGameLevelScoreDisplay');

            // Game state variables
            let gameStarted = false;
            let paused = false;
            let animationFrameId;

            let level = 1;
            const maxLevels = 10;
            let score = 0; // Total score
            let levelScore = 0; // Score to pass level
            const levelScoreTarget = 50; // Points needed to pass level

            // Canvas dimensions
            let canvasWidth;
            let canvasHeight;

            // Player
            const player = {
                x: 0,
                y: 0,
                radius: 20,
                color: '#cbd5e0', // Light gray
                baseSpeed: 5,
                speed: 5
            };

            // Enemies (now an array)
            let enemies = [];
            const baseEnemySize = 30;
            const baseEnemySpeed = 3;

            // Collectible balls
            let collectibles = [];
            const collectibleRadius = 8;
            const collectibleColor = '#f6e05e'; // Light yellow (coins)

            // Initialize Tone.js synths for the simple game
            const collectibleSynth = new Tone.Synth().toDestination();
            const enemySynth = new Tone.NoiseSynth({
                noise: { type: 'white' },
                envelope: { attack: 0.005, decay: 0.1, sustain: 0.05, release: 0.2 }
            }).toDestination();
            const levelUpSynth = new Tone.Synth({
                oscillator: { type: 'triangle' },
                envelope: { attack: 0.01, decay: 0.2, sustain: 0.1, release: 0.5 }
            }).toDestination();


            // Function to show a message in the message box
            function showMessageBox(message) {
                messageText.textContent = message;
                messageBox.style.display = 'block'; // Show message box
            }

            // Function to hide the message box
            function hideMessageBox() {
                messageBox.style.display = 'none'; // Hide message box
                // Clear message text content for the next message
                messageText.textContent = '';
            }

            // Function to adjust canvas size
            function resizeCanvas() {
                canvasWidth = canvas.offsetWidth;
                canvasHeight = canvas.offsetHeight;

                canvas.width = canvasWidth;
                canvas.height = canvasHeight;

                // Reposition player to the center of the canvas
                player.x = canvasWidth / 2;
                player.y = canvasHeight / 2;

                // Reset game if in progress to readjust positions
                if (gameStarted && !paused) {
                    resetLevel(); // This also readjusts enemies and collectibles
                } else if (!gameStarted) {
                    draw(); // Draw initial message if game hasn't started
                }
            }

            // Event listener for window resize
            window.addEventListener('resize', resizeCanvas);

            // Update game stats display
            function updateGameStats() {
                levelDisplay.textContent = level;
                scoreDisplay.textContent = score;
                levelScoreDisplay.textContent = `${levelScore}/${levelScoreTarget}`;
            }

            // Generate enemies for the current level
            function generateEnemies() {
                enemies = []; // Clear existing enemies
                let numEnemies;
                if (level === 1 || level === maxLevels) { // Special case for first and final level
                    numEnemies = 1;
                } else {
                    numEnemies = level + 2; // Increase number of enemies per level for intermediate levels
                }

                for (let i = 0; i < numEnemies; i++) {
                    enemies.push({
                        x: Math.random() * (canvasWidth - baseEnemySize),
                        y: Math.random() * (canvasHeight - baseEnemySize),
                        size: baseEnemySize,
                        color: '#fc8181', // Light red
                        speed: baseEnemySpeed + (level * 0.5), // Increase speed per level
                        directionX: Math.random() > 0.5 ? 1 : -1,
                        directionY: Math.random() > 0.5 ? 1 : -1
                    });
                }
            }

            // Generate collectible balls for the current level
            function generateCollectibles() {
                collectibles = []; // Clear existing collectibles
                const numCollectibles = 10; // Fixed number of collectibles per level
                for (let i = 0; i < numCollectibles; i++) {
                    collectibles.push({
                        x: Math.random() * (canvasWidth - collectibleRadius * 2) + collectibleRadius,
                        y: Math.random() * (canvasHeight - collectibleRadius * 2) + collectibleRadius,
                        radius: collectibleRadius,
                        color: collectibleColor
                    });
                }
            }

            // Reset the level (positions, enemies, collectibles)
            function resetLevel() {
                player.x = canvasWidth / 2;
                player.y = canvasHeight / 2;
                player.speed = player.baseSpeed; // Reset player base speed if modified

                levelScore = 0; // Reset level score
                generateEnemies();
                generateCollectibles();
                updateGameStats();
            }

            // Draw the player
            function drawPlayer() {
                ctx.beginPath();
                ctx.arc(player.x, player.y, player.radius, 0, Math.PI * 2);
                ctx.fillStyle = player.color;
                ctx.fill();
                ctx.closePath();
            }

            // Draw enemies
            function drawEnemies() {
                enemies.forEach(enemy => {
                    ctx.fillStyle = enemy.color;
                    ctx.fillRect(enemy.x, enemy.y, enemy.size, enemy.size);
                });
            }

            // Draw collectible balls
            function drawCollectibles() {
                collectibles.forEach(collectible => {
                    ctx.beginPath();
                    ctx.arc(collectible.x, collectible.y, collectible.radius, 0, Math.PI * 2);
                    ctx.fillStyle = collectible.color;
                    ctx.fill();
                    ctx.closePath();
                });
            }

            // Update enemy positions
            function updateEnemies() {
                enemies.forEach(enemy => {
                    enemy.x += enemy.speed * enemy.directionX;
                    enemy.y += enemy.speed * enemy.directionY;

                    // Bounce off canvas edges
                    if (enemy.x + enemy.size > canvasWidth || enemy.x < 0) {
                        enemy.directionX *= -1;
                    }
                    if (enemy.y + enemy.size > canvasHeight || enemy.y < 0) {
                        enemy.directionY *= -1;
                    }
                });
            }

            // Check collision between player and an enemy
            function checkEnemyCollision() {
                for (let i = 0; i < enemies.length; i++) {
                    const enemy = enemies[i];
                    const distX = Math.abs(player.x - (enemy.x + enemy.size / 2));
                    const distY = Math.abs(player.y - (enemy.y + enemy.size / 2));

                    if (distX <= (enemy.size / 2 + player.radius) && distY <= (enemy.size / 2 + player.radius)) {
                        // Collision with bounding box, check circle-square more precisely
                        const dx = Math.max(0, distX - enemy.size / 2);
                        const dy = Math.max(0, distY - enemy.size / 2);
                        if ((dx * dx + dy * dy) <= (player.radius * player.radius)) {
                            enemySynth.triggerAttackRelease("8n"); // Collision sound
                            return true; // Collision occurred
                        }
                    }
                }
                return false; // No collision with any enemy
            }

            // Check collision between player and collectible balls
            function checkCollectibleCollision() {
                for (let i = collectibles.length - 1; i >= 0; i--) {
                    const collectible = collectibles[i];
                    const distance = Math.sqrt(
                        Math.pow(player.x - collectible.x, 2) + Math.pow(player.y - collectible.y, 2)
                    );
                    if (distance < player.radius + collectible.radius) {
                        // Collision with ball, add points and remove it
                        levelScore += 1;
                        score += 10; // Add 10 points per ball
                        collectibles.splice(i, 1); // Remove the ball
                        updateGameStats();
                        collectibleSynth.triggerAttackRelease("C5", "8n"); // Collectible sound
                    }
                }
            }

            // Move player with arrow keys
            document.addEventListener('keydown', (e) => {
                if (!gameStarted || paused) return;

                switch (e.key) {
                    case 'ArrowUp':
                        player.y = Math.max(player.y - player.speed, player.radius);
                        break;
                    case 'ArrowDown':
                        player.y = Math.min(player.y + player.speed, canvasHeight - player.radius);
                        break;
                    case 'ArrowLeft':
                        player.x = Math.max(player.x - player.speed, player.radius);
                        break;
                    case 'ArrowRight':
                        player.x = Math.min(player.x + player.speed, canvasWidth - player.radius);
                        break;
                }
            });

            // Move player with touch gestures (swipe)
            let touchStartX = 0;
            let touchStartY = 0;

            canvas.addEventListener('touchstart', (e) => {
                if (!gameStarted || paused) return;
                touchStartX = e.touches[0].clientX;
                touchStartY = e.touches[0].clientY;
            });

            canvas.addEventListener('touchmove', (e) => {
                if (!gameStarted || paused) return;
                e.preventDefault(); // Prevent page scrolling

                const touchEndX = e.touches[0].clientX;
                const touchEndY = e.touches[0].clientY;

                const dx = touchEndX - touchStartX;
                const dy = touchEndY - touchStartY;

                // Move player based on drag
                player.x = Math.min(Math.max(player.x + dx * 0.1, player.radius), canvasWidth - player.radius);
                player.y = Math.min(Math.max(player.y + dy * 0.1, player.radius), canvasHeight - player.radius);

                touchStartX = touchEndX;
                touchStartY = touchEndY;
            });

            // Main game loop
            function draw() {
                ctx.clearRect(0, 0, canvasWidth, canvasHeight); // Clear the canvas

                if (!gameStarted) {
                    ctx.font = '24px Inter';
                    ctx.fillStyle = '#e2e8f0'; // Light text
                    ctx.textAlign = 'center';
                    ctx.fillText('Presiona "Iniciar Juego" para comenzar', canvasWidth / 2, canvasHeight / 2);
                    animationFrameId = requestAnimationFrame(draw);
                    return;
                }

                if (paused) {
                    ctx.font = '36px Inter';
                    ctx.fillStyle = '#63b3ed'; // Light blue
                    ctx.textAlign = 'center';
                    ctx.fillText('PAUSA', canvasWidth / 2, canvasHeight / 2);
                    animationFrameId = requestAnimationFrame(draw);
                    return;
                }

                // Game logic
                updateEnemies(); // Update enemy positions
                drawPlayer(); // Draw player
                drawEnemies(); // Draw enemies
                drawCollectibles(); // Draw collectible balls

                checkCollectibleCollision(); // Check collisions with collectibles

                if (checkEnemyCollision()) {
                    stopGame(); // Stop the game if there's an enemy collision
                    showMessageBox(`¬°Colisi√≥n! El juego ha terminado en el Nivel ${level}. Puntuaci√≥n final: ${score}`);
                    return; // Stop the animation loop
                }

                // Level progression logic
                if (levelScore >= levelScoreTarget) {
                    if (level < maxLevels) {
                        level++;
                        levelUpSynth.triggerAttackRelease(["C5", "E5", "G5"], "4n"); // Level complete sound
                        showMessageBox(`¬°Nivel ${level - 1} completado! Preparando Nivel ${level}...`);
                        // Set timeout for the message box to close, then reset the level
                        messageBoxButton.onclick = () => {
                            hideMessageBox();
                            resetLevel();
                            // Re-start the animation loop after the message box is dismissed
                            animationFrameId = requestAnimationFrame(draw);
                        };
                        cancelAnimationFrame(animationFrameId); // Pause the drawing loop
                        return; // Prevent further drawing until message box is dismissed
                    } else {
                        stopGame();
                        levelUpSynth.triggerAttackRelease(["C5", "E5", "G5", "C6"], "2n"); // Final victory sound
                        showMessageBox(`¬°Felicidades! ¬°Has completado todos los ${maxLevels} niveles! Puntuaci√≥n final: ${score}`);
                        return;
                    }
                }

                animationFrameId = requestAnimationFrame(draw); // Continue the loop
            }

            // Function to start the game
            function startGame() {
                if (!gameStarted) {
                    gameStarted = true;
                    paused = false;
                    hideMessageBox(); // Hide any previous message
                    level = 1;
                    score = 0;
                    levelScore = 0;
                    resetLevel(); // Set up the first level
                    animationFrameId = requestAnimationFrame(draw); // Start the animation loop
                } else if (paused) {
                    resumeGame();
                }
            }

            // Function to pause the game
            function pauseGame() {
                if (gameStarted && !paused) {
                    paused = true;
                    // We don't cancel animationFrameId here, we let draw draw the pause message
                }
            }

            // Function to resume the game
            function resumeGame() {
                if (gameStarted && paused) {
                    paused = false;
                    // draw() is already in the loop, we just need to change the `paused` state
                }
            }

            // Function to stop the game (complete reset)
            function stopGame() {
                if (gameStarted || paused) {
                    gameStarted = false;
                    paused = false;
                    cancelAnimationFrame(animationFrameId); // Stop the animation loop
                    // Reset everything to its initial state for the next start
                    level = 1;
                    score = 0;
                    levelScore = 0;
                    updateGameStats();
                    // Draw the initial "Press Start Game" message
                    ctx.clearRect(0, 0, canvasWidth, canvasHeight);
                    ctx.font = '24px Inter';
                    ctx.fillStyle = '#e2e8f0';
                    ctx.textAlign = 'center';
                    ctx.fillText('Presiona "Iniciar Juego" para comenzar', canvasWidth / 2, canvasHeight / 2);
                }
            }

            // Event listeners for buttons
            startButton.addEventListener('click', startGame);
            pauseButton.addEventListener('click', pauseGame);
            stopButton.addEventListener('click', stopGame);
            messageBoxButton.addEventListener('click', hideMessageBox); // Attach listener directly

            // Public init function for the module
            function init() {
                resizeCanvas();
                stopGame(); // Ensures the game is in a stopped state with the initial message
            }

            return {
                init: init,
                startGame: startGame,
                pauseGame: pauseGame,
                resumeGame: resumeGame,
                stopGame: stopGame
            };
        })();


        // --- Initialization on Window Load ---
        window.onload = function() {
            showGamePortal(); // Show the game portal by default
        };
    </script>
</body>
</html>
